<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}" key="deleteLotConfirmation"></p-confirmDialog>

<div class="grid p-fluid">

  <!-- Section Nouvelle Vente -->
  <div class="col-12 md:col-6">
    <p-panel header="Nouvelle Vente">
      <div class="p-fluid">
        <div class="field">
          <label for="produitVenteSelect">Produit</label>
          <p-dropdown id="produitVenteSelect"
                      [options]="produitsDisponiblesPourVente"
                      [(ngModel)]="selectedProduitIdPourPanier"
                      optionLabel="nomMedicament"
                      optionValue="id"
                      placeholder="Sélectionner un produit"
                      [filter]="true" filterBy="nomMedicament" [showClear]="true"
                      [style]="{width: '100%'}"
                      [loading]="isLoadingVente && produitsDisponiblesPourVente.length === 0">
            <ng-template let-produit pTemplate="item">
              <div>{{produit.nomMedicament}} (Stock: {{produit.quantiteTotaleEnStock}}, Prix: {{produit.prixVenteTTC | currency:'EUR'}})</div>
            </ng-template>
          </p-dropdown>
        </div>
        <div class="field">
          <label for="quantiteVenteInput">Quantité</label>
          <p-inputNumber id="quantiteVenteInput" [(ngModel)]="quantitePourProduitPanier" [min]="1" [showButtons]="true"></p-inputNumber>
        </div>
        <p-button label="Ajouter au Panier" icon="pi pi-plus" (click)="ajouterAuPanier()" [disabled]="!selectedProduitIdPourPanier || quantitePourProduitPanier <= 0"></p-button>
      </div>

      <h4 class="mt-4">Panier Actuel</h4>
      <div *ngIf="panier.length === 0" class="text-center my-3">Le panier est vide.</div>
      <p-table *ngIf="panier.length > 0" [value]="panier" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Produit</th>
            <th>Qté</th>
            <th>Prix Unit.</th>
            <th>Sous-total</th>
            <th>Action</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{item.nomMedicament}}</td>
            <td>{{item.quantiteAVendre}}</td>
            <td>{{item.prixVenteTTC | currency:'EUR'}}</td>
            <td>{{(item.prixVenteTTC * item.quantiteAVendre) | currency:'EUR'}}</td>
            <td><p-button icon="pi pi-trash" styleClass="p-button-danger p-button-sm" (click)="retirerDuPanier(item.id)"></p-button></td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td colspan="3" class="text-right"><strong>Total:</strong></td>
            <td colspan="2"><strong>{{calculerTotalPanier() | currency:'EUR'}}</strong></td>
          </tr>
        </ng-template>
      </p-table>
      <div class="mt-3 text-right" *ngIf="panier.length > 0">
        <!-- TODO: Ajouter sélection utilisateur si nécessaire -->
        <!-- <div class="field">
          <label for="userVenteSelect">Vendeur (Utilisateur ID: {{currentUserId}})</label>
           <p-dropdown placeholder="Sélectionner Vendeur" ...></p-dropdown>
        </div> -->
        <p-button label="Finaliser la Vente" icon="pi pi-check" (click)="finaliserVente()" [loading]="isLoadingVente" styleClass="p-button-success"></p-button>
      </div>
    </p-panel>
  </div>

  <!-- Section Historique des Ventes -->
<div class="col-12 md:col-6">
    <p-panel header="Historique des Ventes">
      <p-button label="Actualiser" icon="pi pi-refresh" (click)="loadHistoriqueVentes()" [loading]="isLoadingHistorique" styleClass="p-button-sm mb-2"></p-button>
      <p-table [value]="historiqueVentes" [loading]="isLoadingHistorique" [rows]="5" [paginator]="true" responsiveLayout="scroll" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="id">ID <p-sortIcon field="id"></p-sortIcon></th>
            <th pSortableColumn="dateVente">Date <p-sortIcon field="dateVente"></p-sortIcon></th>
            <th pSortableColumn="montantTotal">Total <p-sortIcon field="montantTotal"></p-sortIcon></th>
            <th>Utilisateur</th>
            <th>Détails</th>
            <th>Actions</th> <!-- NOUVELLE COLONNE -->
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-vente>
          <tr>
            <td>{{vente.id}}</td>
            <td>{{vente.dateVente | date:'dd/MM/yyyy HH:mm'}}</td>
            <td>{{vente.montantTotal | currency:'EUR'}}</td>
            <td>{{vente.utilisateur?.username || vente.utilisateur?.id || 'N/A'}}</td>
            <td>
                <button pButton pRipple type="button" icon="pi pi-eye" class="p-button-rounded p-button-text" (click)="showVenteDetails(vente)" pTooltip="Voir détails" tooltipPosition="top"></button>
            </td>
            <td> <!-- NOUVELLES ACTIONS -->
                <button pButton pRipple type="button" icon="pi pi-pencil" class="p-button-rounded p-button-warning p-button-text mr-2" (click)="openEditVenteDialog(vente)" pTooltip="Modifier Vente" tooltipPosition="top"></button>
                <button pButton pRipple type="button" icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text" (click)="confirmDeleteVente(vente)" pTooltip="Supprimer Vente" tooltipPosition="top"></button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <!-- Modifiez colspan pour inclure la nouvelle colonne -->
          <tr><td colspan="6" class="text-center">Aucune vente dans l'historique.</td></tr>
        </ng-template>
      </p-table>
    </p-panel>
  </div>
 <p-dialog header="Modifier la Vente" [(visible)]="editVenteDialogVisible" [modal]="true" [style]="{width: '70vw', 'min-width': '400px'}" (onHide)="hideEditVenteDialog()">
    <ng-template pTemplate="content">
      <div *ngIf="venteToEdit">
        <p>Édition de la vente N°{{venteToEdit.id}}.</p>
        <p class="text-orange-500">Attention: La modification complète des ventes (produits, quantités) est une opération complexe qui nécessite une logique d'interface utilisateur et un support backend robustes pour gérer les impacts sur les stocks et les totaux.</p>
        <p>Pour l'instant, ce dialogue est un placeholder. Vous devrez implémenter un formulaire ici, potentiellement similaire à la section "Nouvelle Vente", pré-rempli avec les données de `venteToEdit`.</p>
        
        <!-- Exemple de champs que vous pourriez vouloir éditer -->
        <!-- <div class="field">
          <label for="editVenteUserId">ID Utilisateur (si modifiable)</label>
          <input pInputText id="editVenteUserId" [(ngModel)]="venteToEdit.utilisateur.id" />
        </div> -->
        <!-- Ici, vous auriez une table ou une liste pour les lignes de vente, permettant de modifier les quantités, supprimer des lignes, ajouter de nouveaux produits -->
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <p-button label="Annuler" icon="pi pi-times" (click)="hideEditVenteDialog()" styleClass="p-button-text"></p-button>
      <p-button label="Sauvegarder Modifications" icon="pi pi-check" (click)="saveEditedVente()" [loading]="isSubmittingEditVente" styleClass="p-button-success"></p-button>
    </ng-template>
  </p-dialog>

  </div>