<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}" key="deleteLotConfirmation"></p-confirmDialog>

<div class="grid p-fluid">

  <!-- Section Nouvelle Vente -->
  <div class="col-12 md:col-6">
    <p-panel header="Nouvelle Vente">
      <div class="p-fluid">
        <div class="field">
          <label for="produitVenteSelect">Produit</label>
          <p-dropdown id="produitVenteSelect"
                      [options]="produitsDisponiblesPourVente"
                      [(ngModel)]="selectedProduitIdPourPanier"
                      optionLabel="nomMedicament"
                      optionValue="id"
                      placeholder="Sélectionner un produit"
                      [filter]="true" filterBy="nomMedicament" [showClear]="true"
                      [style]="{width: '100%'}"
                      [loading]="isLoadingVente && produitsDisponiblesPourVente.length === 0">
            <ng-template let-produit pTemplate="item">
              <div>{{produit.nomMedicament}} (Stock: {{produit.quantiteTotaleEnStock}}, Prix: {{produit.prixVenteTTC | currency:'DH'}})</div>
            </ng-template>
          </p-dropdown>
        </div>
        <div class="field">
          <label for="quantiteVenteInput">Quantité</label>
          <p-inputNumber id="quantiteVenteInput" [(ngModel)]="quantitePourProduitPanier" [min]="1" [showButtons]="true"></p-inputNumber>
        </div>
        <p-button label="Ajouter au Panier" icon="pi pi-plus" (click)="ajouterAuPanier()" [disabled]="!selectedProduitIdPourPanier || quantitePourProduitPanier <= 0"></p-button>
      </div>

      <h4 class="mt-4">Panier Actuel</h4>
      <div *ngIf="panier.length === 0" class="text-center my-3">Le panier est vide.</div>
      <p-table *ngIf="panier.length > 0" [value]="panier" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Produit</th>
            <th>Qté</th>
            <th>Prix Unit.</th>
            <th>Sous-total</th>
            <th>Action</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{item.nomMedicament}}</td>
            <td>{{item.quantiteAVendre}}</td>
            <td>{{item.prixVenteTTC | currency:'DH'}}</td>
            <td>{{(item.prixVenteTTC * item.quantiteAVendre) | currency:'DH'}}</td>
            <td><p-button icon="pi pi-trash" styleClass="p-button-danger p-button-sm" (click)="retirerDuPanier(item.id)"></p-button></td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td colspan="3" class="text-right"><strong>Total:</strong></td>
            <td colspan="2"><strong>{{calculerTotalPanier() | currency:'EUR'}}</strong></td>
          </tr>
        </ng-template>
      </p-table>
      <div class="mt-3 text-right" *ngIf="panier.length > 0">
        <!-- TODO: Ajouter sélection utilisateur si nécessaire -->
        <!-- <div class="field">
          <label for="userVenteSelect">Vendeur (Utilisateur ID: {{currentUserId}})</label>
           <p-dropdown placeholder="Sélectionner Vendeur" ...></p-dropdown>
        </div> -->
        <p-button label="Finaliser la Vente" icon="pi pi-check" (click)="finaliserVente()" [loading]="isLoadingVente" styleClass="p-button-success"></p-button>
      </div>
    </p-panel>
  </div>

  <!-- Section Historique des Ventes -->
<div class="col-12 md:col-6">
    <p-panel header="Historique des Ventes">
      <p-button label="Actualiser" icon="pi pi-refresh" (click)="loadHistoriqueVentes()" [loading]="isLoadingHistorique" styleClass="p-button-sm mb-2"></p-button>
      <p-table [value]="historiqueVentes" [loading]="isLoadingHistorique" [rows]="5" [paginator]="true" responsiveLayout="scroll" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="id">ID <p-sortIcon field="id"></p-sortIcon></th>
            <th pSortableColumn="dateVente">Date <p-sortIcon field="dateVente"></p-sortIcon></th>
            <th pSortableColumn="montantTotal">Total <p-sortIcon field="montantTotal"></p-sortIcon></th>
            <th>Utilisateur</th>
            
            <th>Actions</th> <!-- NOUVELLE COLONNE -->
          </tr>
        </ng-template>
    <ng-template pTemplate="body" let-vente>
          <tr>
            <td data-label="ID">{{vente.id}}</td>
            <td data-label="Date">{{vente.dateVente | date:'dd/MM/yyyy HH:mm'}}</td>
            <td data-label="Total">{{vente.montantTotal | currency:'EUR'}}</td>
            <!-- <td data-label="Utilisateur">{{vente.utilisateur?.username || vente.utilisateur?.id || 'N/A'}}</td> -->
            <td data-label="Détails">
                <button pButton pRipple type="button" icon="pi pi-eye" class="p-button-rounded p-button-text p-button-info" (click)="showVenteDetails(vente)" pTooltip="Voir détails" tooltipPosition="top"></button>
            </td>
            <td data-label="Actions">
                <button pButton pRipple type="button" icon="pi pi-pencil" class="p-button-rounded p-button-warning p-button-text mr-2" (click)="openEditVenteDialog(vente)" pTooltip="Modifier Vente" tooltipPosition="top"></button>
                <button pButton pRipple type="button" icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text" (click)="confirmDeleteVente(vente)" pTooltip="Supprimer Vente" tooltipPosition="top"></button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <!-- Modifiez colspan pour inclure la nouvelle colonne -->
          <tr><td colspan="6" class="text-center">Aucune vente dans l'historique.</td></tr>
        </ng-template>
      </p-table>
    </p-panel>
  </div>
<!-- Dialogue pour Éditer une Vente -->
<p-dialog header="Modifier la Vente" [(visible)]="editVenteDialogVisible" [modal]="true" [style]="{width: '70vw', 'min-width': '500px'}" (onHide)="hideEditVenteDialog()">
    <ng-template pTemplate="content">
        <div *ngIf="venteToEdit">
            <p>Édition de la vente N°{{venteToEdit.id}} du {{venteToEdit.dateVente | date:'dd/MM/yyyy HH:mm'}}</p>
            <div class="p-fluid grid mt-3">
                <div class="field col-12 md:col-6">
                    <label for="produitEditVenteSelect">Produit</label>
                    <p-dropdown id="produitEditVenteSelect"
                                [options]="produitsDisponiblesPourVente"
                                [(ngModel)]="selectedProduitIdPourEditionPanier"
                                optionLabel="nomMedicament"
                                optionValue="id"
                                placeholder="Sélectionner un produit"
                                [filter]="true" filterBy="nomMedicament" [showClear]="true"
                                [style]="{width: '100%'}">
                        <ng-template let-produit pTemplate="item">
                            <div>{{produit.nomMedicament}} (Stock: {{produit.quantiteTotaleEnStock}}, Prix: {{produit.prixVenteTTC | currency:'EUR'}})</div>
                        </ng-template>
                    </p-dropdown>
                </div>
                <div class="field col-12 md:col-4">
                    <label for="quantiteEditVenteInput">Quantité</label>
                    <p-inputNumber id="quantiteEditVenteInput" [(ngModel)]="quantitePourProduitEditionPanier" [min]="1" [showButtons]="true"></p-inputNumber>
                </div>
                <div class="field col-12 md:col-2 align-self-end">
                    <p-button label="Ajouter" icon="pi pi-plus" (click)="ajouterAuPanierEdition()" [disabled]="!selectedProduitIdPourEditionPanier || quantitePourProduitEditionPanier <= 0"></p-button>
                </div>
            </div>

            <h5 class="mt-4">Panier d'Édition</h5>
            <div *ngIf="panierPourEdition.length === 0" class="text-center my-3">Le panier d'édition est vide.</div>
            <p-table *ngIf="panierPourEdition.length > 0" [value]="panierPourEdition" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Produit</th>
                        <th>Qté</th>
                        <th>Prix Unit.</th>
                        <th>Sous-total</th>
                        <th>Action</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-item>
                    <tr>
                        <td>{{item.nomMedicament}}</td>
                        <td>{{item.quantiteAVendre}}</td>
                        <td>{{item.prixVenteTTC | currency:'EUR'}}</td>
                        <td>{{(item.prixVenteTTC * item.quantiteAVendre) | currency:'DH'}}</td>
                        <td><p-button icon="pi pi-trash" styleClass="p-button-danger p-button-sm" (click)="retirerDuPanierEdition(item.id)"></p-button></td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="footer">
                    <tr>
                        <td colspan="3" class="text-right"><strong>Total Modifié:</strong></td>
                        <td colspan="2"><strong>{{calculerTotalPanierEdition() | currency:'DH'}}</strong></td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <p-button label="Annuler" icon="pi pi-times" (click)="hideEditVenteDialog()" styleClass="p-button-text"></p-button>
        <p-button label="Sauvegarder Modifications" icon="pi pi-check" (click)="saveEditedVente()" [loading]="isSubmittingEditVente" styleClass="p-button-success" [disabled]="panierPourEdition.length === 0"></p-button>
    </ng-template>
</p-dialog>

  </div>